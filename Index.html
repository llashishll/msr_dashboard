<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Satsang Dashboard by Day</title>
    <link rel="stylesheet" href="dashboard_styles.css">
</head>
<body>
    <h1>Satsang Report by Day</h1>

    <!-- Controls -->
    <div class="controls">
        <label for="monthSelector">Select Month:</label>
        <select id="monthSelector">
            <? if (availableMonths && availableMonths.length > 0) { ?> <? availableMonths.forEach(month => { var displayMonth = month; try { var parts = month.split('-'); var date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1); displayMonth = date.toLocaleDateString(undefined, { month: 'short', year: 'numeric' }); } catch(e) {} ?> <option value="<?= month ?>" <?= month === selectedMonth ? 'selected' : '' ?>><?!= displayMonth ?></option> <? }) ?> <? } else if (selectedMonth) { ?> <? var displayMonth = selectedMonth; try { var parts = selectedMonth.split('-'); var date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1); displayMonth = date.toLocaleDateString(undefined, { month: 'short', year: 'numeric' }); } catch(e) {} ?> <option value="<?= selectedMonth ?>" selected><?!= displayMonth ?> (No Data)</option> <? } else { ?> <option value="" disabled selected>-- No Months Available --</option> <? } ?>
        </select>
        <button id="exportButton" <?!= !selectedMonth ? 'disabled' : '' ?> >Export <?= selectedMonth ? selectedMonth : 'Month' ?> to Excel</button>
        <span id="exportStatus"></span>
        <button id="sortCustomButton">Sort by Custom Order</button>
        <button id="copyMissingEntriesButton">Copy Missing Sunday Entries</button>
        <span id="copyStatus"></span>
    </div>

    <? if (error) { ?>
        <p class="status-error">Error loading dashboard: <?= error ?></p>
    <? } else if (!selectedMonth) { ?>
         <p class="no-data">Please select a month, or add data to the sheet.</p>
    <? } else { ?>

        <!-- ===================================================== -->
        <!-- PIVOTED TABLES (Sunday / Wednesday)                   -->
        <!-- ===================================================== -->
        <? function generatePivotedTable(title, data, sortedDates, eventDetailHeaders, eventDetailKeys, selectedMonth, tableId) { ?>
            <h2><?= title ?></h2>
            <? if (!data || !data.templateData || data.templateData.length === 0) { ?>
                 <? var displayMonth = selectedMonth; try { var parts = selectedMonth.split('-'); var date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1); displayMonth = date.toLocaleDateString(undefined, { month: 'long', year: 'numeric' }); } catch(e) {} ?>
                <p class="no-data">No <?= title.toLowerCase() ?> data available for <?= displayMonth ?>.</p>
            <? } else { ?>
                <table id="<?= tableId ?>">
                    <thead>
                        <tr>
                            <th class="sn-header" rowspan="2">S.N.</th> <th class="avg-header" rowspan="2">Avg Sangat</th> <th class="centre-header" rowspan="2">Centre/Subcentre</th>
                            <? if (sortedDates && sortedDates.length > 0) { ?> <? for (var i = 0; i < sortedDates.length; i++) { ?> <th class="date-header" colspan="<?= eventDetailHeaders.length ?>"><?= sortedDates[i] /* Adjusted Date Header */ ?></th> <? } ?> <? } ?>
                        </tr>
                        <tr>
                            <? if (sortedDates && sortedDates.length > 0) { ?> <? for (var d = 0; d < sortedDates.length; d++) { ?> <? for (var c = 0; c < eventDetailHeaders.length; c++) { ?> <th class="sub-header"><?= eventDetailHeaders[c] ?></th> <? } ?> <? } ?> <? } ?>
                        </tr>
                    </thead>
                    <tbody>
                        <? for (var i = 0; i < data.templateData.length; i++) { var centreRow = data.templateData[i]; ?>
                            <tr>
                                <td class="sn-cell"><?= i + 1 ?></td> <td class="avg-cell"><?= centreRow.averageSangat ?></td> <td class="centre-cell <?= centreRow.isBold ? 'bold-centre' : '' ?>"><?= centreRow.centre ?></td>
                                <? if (sortedDates && sortedDates.length > 0) { ?> <? for (var d = 0; d < sortedDates.length; d++) { var dateKey = sortedDates[d]; var eventDataForDate = centreRow.dateData[dateKey] || {}; ?> <? eventDetailKeys.forEach(colKey => { var displayValue = eventDataForDate[colKey]; displayValue = (displayValue === null || displayValue === undefined) ? '' : displayValue; ?> <td><?= displayValue ?></td> <? }); ?> <? } ?> <? } ?>
                            </tr>
                        <? } ?>
                    </tbody>
                </table>
            <? } ?>
        <? } ?>

        <? generatePivotedTable('Sunday Satsangs', sundayData, sundayData ? sundayData.sortedDates : [], eventDetailHeaders, eventDetailKeys, selectedMonth, 'sundayTable'); ?>
        <? generatePivotedTable('Wednesday Satsangs', wednesdayData, wednesdayData ? wednesdayData.sortedDates : [], eventDetailHeaders, eventDetailKeys, selectedMonth, 'wednesdayTable'); ?>


        <!-- ===================================================== -->
        <!-- UNPIVOTED LIST TABLE (Special Satsangs)             -->
        <!-- ===================================================== -->
        <h2>Special Satsangs (Other Days)</h2>
        <?
          // Define local variables for the special table section
          var _specialData = typeof specialData !== 'undefined' ? specialData : null;
          var _headers = typeof specialEventTableHeaders !== 'undefined' ? specialEventTableHeaders : null;
          var _keys = typeof specialEventTableKeys !== 'undefined' ? specialEventTableKeys : null;
          var _displayMonth = selectedMonth;
          try { var parts = selectedMonth.split('-'); var date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1); _displayMonth = date.toLocaleDateString(undefined, { month: 'long', year: 'numeric' }); } catch(e) {}

          // Check if data exists
          if (!_specialData || _specialData.length === 0) {
        ?>
            <p class="no-data">No special satsang data available for <?= _displayMonth ?>.</p>
        <?
          // Check if headers/keys config exists (problem if data exists but config doesn't)
          } else if (!_headers || _headers.length === 0 || !_keys || _keys.length === 0) {
        ?>
            <p class="status-error">Error: Special Satsang table configuration is missing. Cannot display data.</p>
        <?
          // If both data and config exist, build the table
          } else {
        ?>
            <table>
                <thead>
                    <tr>
                        <? _headers.forEach(header => { ?>
                            <th><?= header ?></th>
                        <? }); ?>
                    </tr>
                </thead>
                <tbody>
                    <? _specialData.forEach(event => { // Loop through the array of event objects ?>
                        <tr>
                            <? _keys.forEach(key => { // Loop through the keys to get cell data
                                 var displayValue = event[key];
                                 displayValue = (displayValue === null || displayValue === undefined) ? '' : displayValue;
                            ?>
                                <td><?= displayValue ?></td>
                            <? }); ?>
                        </tr>
                    <? }); ?>
                </tbody>
            </table>
        <?
          } // End of the 'else' for building the special table
        ?>

    <? } // End of the primary <? } else { ?> block after error/no selected month check ?>

    <!-- Add this next to your existing export button -->
    <button id="exportCompleteButton" class="control-button">Export Complete Report</button>
    <span id="exportCompleteStatus"></span>

    <!-- JavaScript for both export buttons -->
    <script>
      const selectedMonth = '<?= selectedMonth ?>';
      const eventDetailHeadersJs = <?= JSON.stringify(eventDetailHeaders) ?>;
      const eventDetailKeysJs = <?= JSON.stringify(eventDetailKeys) ?>;

      // Export button for regular export
      document.getElementById('exportButton').addEventListener('click', function() {
        var statusSpan = document.getElementById('exportStatus');
        var exportButton = this;
        
        if (!selectedMonth) {
          statusSpan.textContent = 'Error: No month selected.';
          statusSpan.className = 'status-error';
          return;
        }
        
        statusSpan.textContent = 'Generating Excel for ' + selectedMonth + '...';
        statusSpan.className = '';
        exportButton.disabled = true;
        
        google.script.run
          .withSuccessHandler(function(downloadUrl) {
            if (downloadUrl && typeof downloadUrl === 'string' && downloadUrl.startsWith('http')) {
              statusSpan.textContent = 'Export successful!';
              statusSpan.className = 'status-success';
              
              var link = document.createElement('a');
              link.href = downloadUrl;
              link.target = '_blank';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              
              setTimeout(() => {
                statusSpan.textContent = '';
                statusSpan.className = '';
              }, 7000);
            } else {
              statusSpan.textContent = 'Export failed. Invalid response. Check Logs.';
              statusSpan.className = 'status-error';
              console.error('Export failed, invalid URL:', downloadUrl);
            }
            exportButton.disabled = false;
          })
          .withFailureHandler(function(error) {
            statusSpan.textContent = 'Export failed: ' + error.message;
            statusSpan.className = 'status-error';
            console.error('Export Error:', error);
            exportButton.disabled = false;
          })
          .exportFilteredDataToExcel(selectedMonth);
      });
      
      // Export button for complete export
      document.getElementById('exportCompleteButton').addEventListener('click', function() {
        var statusSpan = document.getElementById('exportCompleteStatus');
        var exportButton = this;
        
        if (!selectedMonth) {
          statusSpan.textContent = 'Error: No month selected.';
          statusSpan.className = 'status-error';
          return;
        }
        
        statusSpan.textContent = 'Generating Complete Excel for ' + selectedMonth + '...';
        statusSpan.className = '';
        exportButton.disabled = true;
        
        google.script.run
          .withSuccessHandler(function(downloadUrl) {
            if (downloadUrl && typeof downloadUrl === 'string' && downloadUrl.startsWith('http')) {
              statusSpan.textContent = 'Complete Export successful!';
              statusSpan.className = 'status-success';
              
              var link = document.createElement('a');
              link.href = downloadUrl;
              link.target = '_blank';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              
              setTimeout(() => {
                statusSpan.textContent = '';
                statusSpan.className = '';
              }, 7000);
            } else {
              statusSpan.textContent = 'Complete Export failed. Invalid response. Check Logs.';
              statusSpan.className = 'status-error';
              console.error('Complete Export failed, invalid URL:', downloadUrl);
            }
            exportButton.disabled = false;
          })
          .withFailureHandler(function(error) {
            statusSpan.textContent = 'Complete Export failed: ' + error.message;
            statusSpan.className = 'status-error';
            console.error('Complete Export Error:', error);
            exportButton.disabled = false;
          })
          .exportCompleteDataToExcel(selectedMonth);
      });

      // Sort button for custom order
      document.getElementById('sortCustomButton').addEventListener('click', function() {
        var sortButton = this;
        var statusSpan = document.getElementById('copyStatus'); // Using copyStatus for sort messages for now
        sortButton.disabled = true;
        sortButton.textContent = 'Sorting...';
        statusSpan.textContent = 'Sorting table...';
        statusSpan.className = '';

        google.script.run
          .withSuccessHandler(function(sundayDataResult) {
            if (sundayDataResult && sundayDataResult.templateData) {
              // Re-render the Sunday table
              const sundayTable = document.getElementById('sundayTable');
              if (sundayTable) {
                // Clear existing rows
                const tbody = sundayTable.getElementsByTagName('tbody')[0];
                tbody.innerHTML = ''; 
                
                // Populate with new sorted data
                sundayDataResult.templateData.forEach((centreRow, index) => {
                  const row = tbody.insertRow();
                  row.insertCell().textContent = index + 1;
                  row.cells[0].className = 'sn-cell';
                  row.insertCell().textContent = centreRow.averageSangat;
                  row.cells[1].className = 'avg-cell';
                  row.insertCell().textContent = centreRow.centre;
                  row.cells[2].className = 'centre-cell ' + (centreRow.isBold ? 'bold-centre' : '');

                  if (sundayDataResult.sortedDates && sundayDataResult.sortedDates.length > 0) {
                    sundayDataResult.sortedDates.forEach(dateKey => {
                      const eventDataForDate = centreRow.dateData[dateKey] || {};
                      eventDetailKeysJs.forEach(colKey => {
                        let displayValue = eventDataForDate[colKey];
                        displayValue = (displayValue === null || displayValue === undefined) ? '' : displayValue;
                        row.insertCell().textContent = displayValue;
                      });
                    });
                  }
                });
              }
              statusSpan.textContent = 'Table sorted by custom order.';
              statusSpan.className = 'status-success';
              sortButton.textContent = 'Sort by Custom Order';
            } else if (sundayDataResult && sundayDataResult.error) {
                statusSpan.textContent = 'Error sorting: ' + sundayDataResult.error;
                statusSpan.className = 'status-error';
                sortButton.textContent = 'Sort by Custom Order';
            } else {
                statusSpan.textContent = 'Error sorting: No data returned.';
                statusSpan.className = 'status-error';
                sortButton.textContent = 'Sort by Custom Order';
            }
            sortButton.disabled = false;
            setTimeout(() => { statusSpan.textContent = ''; statusSpan.className = ''; }, 7000);
          })
          .withFailureHandler(function(error) {
            statusSpan.textContent = 'Failed to sort: ' + error.message;
            statusSpan.className = 'status-error';
            sortButton.disabled = false;
            sortButton.textContent = 'Sort by Custom Order';
            setTimeout(() => { statusSpan.textContent = ''; statusSpan.className = ''; }, 7000);
          })
          .getSundayData(selectedMonth, 'custom'); // Request custom sorted data
      });

      // Copy Missing Sunday Entries button
      document.getElementById('copyMissingEntriesButton').addEventListener('click', function() {
        var copyButton = this;
        var statusSpan = document.getElementById('copyStatus');
        copyButton.disabled = true;
        statusSpan.textContent = 'Processing...';
        statusSpan.className = '';

        google.script.run
          .withSuccessHandler(function(copyString) {
            if (copyString && typeof copyString === 'string') {
              if (copyString === "No missing Sunday entries found.") {
                 statusSpan.textContent = copyString;
                 statusSpan.className = '';
              } else {
                navigator.clipboard.writeText(copyString)
                  .then(() => {
                    statusSpan.textContent = 'Copied to clipboard!';
                    statusSpan.className = 'status-success';
                  })
                  .catch(err => {
                    statusSpan.textContent = 'Failed to copy. See console.';
                    statusSpan.className = 'status-error';
                    console.error('Clipboard copy error:', err);
                  });
              }
            } else {
              statusSpan.textContent = 'Failed: Invalid response.';
              statusSpan.className = 'status-error';
              console.error('Copy missing entries failed, invalid response:', copyString);
            }
            copyButton.disabled = false;
             setTimeout(() => {
                statusSpan.textContent = '';
                statusSpan.className = '';
              }, 7000);
          })
          .withFailureHandler(function(error) {
            statusSpan.textContent = 'Error: ' + error.message;
            statusSpan.className = 'status-error';
            console.error('Copy missing entries error:', error);
            copyButton.disabled = false;
          })
          .getMissingSundayEntriesForClipboard(selectedMonth);
      });

    </script>

</body>
</html>